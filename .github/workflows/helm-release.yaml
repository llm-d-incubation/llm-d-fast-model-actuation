name: Release – Build Images & Publish Helm Charts to GHCR

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.3.1) - for testing without creating a release'
        required: true
        type: string
  push:
    tags:
      - 'v*'

permissions:
  contents: read
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------
      # 1. Checkout repo
      # -----------------------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag && format('refs/tags/{0}', github.event.inputs.tag) || github.ref }}
          token: ${{ github.token }}
          persist-credentials: true

      # -----------------------------------------
      # 2. Determine version from tag (v0.3.1 → 0.3.1)
      # -----------------------------------------
      - name: Determine version from tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            RAW_TAG="${{ github.event.inputs.tag }}"
            if [[ -z "$RAW_TAG" ]]; then
              echo "Error: tag input required for workflow_dispatch" >&2
              exit 1
            fi
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            RAW_TAG="${GITHUB_REF#refs/tags/}"
          else
            RAW_TAG="${GITHUB_REF#refs/tags/}"
          fi
          VERSION="${RAW_TAG#v}"
          echo "tag=$RAW_TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # -----------------------------------------
      # 3. Set up build tools
      # -----------------------------------------
      - name: Install ko
        uses: ko-build/setup-ko@v0.7

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # -----------------------------------------
      # 4. Log in to GHCR
      # -----------------------------------------
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------
      # 5. Build and push controller image
      # -----------------------------------------
      - name: Build and push controller image
        run: |
          TAG="${{ steps.version.outputs.tag }}"

          make build-controller \
            CONTAINER_IMG_REG=ghcr.io/${{ github.repository }} \
            CONTROLLER_IMG_TAG=$TAG

          echo "Controller image published: ghcr.io/${{ github.repository }}/dual-pods-controller:$TAG"

      # -----------------------------------------
      # 6. Build and push populator image
      # -----------------------------------------
      - name: Build and push populator image
        run: |
          TAG="${{ steps.version.outputs.tag }}"

          make build-populator \
            CONTAINER_IMG_REG=ghcr.io/${{ github.repository }} \
            POPULATOR_IMG_TAG=$TAG

          echo "Populator image published: ghcr.io/${{ github.repository }}/launcher-populator:$TAG"

      # -----------------------------------------
      # 7. Build and push launcher image
      # -----------------------------------------
      - name: Build and push launcher image
        run: |
          TAG="${{ steps.version.outputs.tag }}"

          make build-and-push-launcher \
            CONTAINER_IMG_REG=ghcr.io/${{ github.repository }} \
            LAUNCHER_IMG_TAG=$TAG

          echo "Launcher image published: ghcr.io/${{ github.repository }}/launcher:$TAG"

      # -----------------------------------------
      # 8. Build and push requester image
      # -----------------------------------------
      - name: Build and push requester image
        run: |
          TAG="${{ steps.version.outputs.tag }}"

          make build-and-push-requester \
            CONTAINER_IMG_REG=ghcr.io/${{ github.repository }} \
            REQUESTER_IMG_TAG=$TAG

          echo "Requester image published: ghcr.io/${{ github.repository }}/requester:$TAG"

      # -----------------------------------------
      # 9. Install Helm
      # -----------------------------------------
      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.16.3'

      # -----------------------------------------
      # 9. Update Helm charts with release version
      # -----------------------------------------
      - name: Update Helm chart files with version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"

          # Update dpctlr chart
          DPCTLR_CHART="charts/dpctlr"
          sed -i "s/^version:.*/version: ${VERSION}/" $DPCTLR_CHART/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${TAG}\"/" $DPCTLR_CHART/Chart.yaml
          sed -i "s|Image:.*|Image: ghcr.io/${{ github.repository }}/dual-pods-controller:${TAG}|" $DPCTLR_CHART/values.yaml

          echo "Updated $DPCTLR_CHART/Chart.yaml:"
          grep -E '^(version|appVersion):' $DPCTLR_CHART/Chart.yaml
          echo "Updated $DPCTLR_CHART/values.yaml:"
          grep '^Image:' $DPCTLR_CHART/values.yaml

          # Update launcher-populator chart
          POPULATOR_CHART="charts/launcher-populator"
          sed -i "s/^version:.*/version: ${VERSION}/" $POPULATOR_CHART/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${TAG}\"/" $POPULATOR_CHART/Chart.yaml
          sed -i "s|repository:.*|repository: ghcr.io/${{ github.repository }}/launcher-populator|" $POPULATOR_CHART/values.yaml
          sed -i "s/tag:.*/tag: ${TAG}/" $POPULATOR_CHART/values.yaml

          echo "Updated $POPULATOR_CHART/Chart.yaml:"
          grep -E '^(version|appVersion):' $POPULATOR_CHART/Chart.yaml
          echo "Updated $POPULATOR_CHART/values.yaml:"
          grep -E '(repository|tag):' $POPULATOR_CHART/values.yaml

      # -----------------------------------------
      # 10. Login to GHCR for Helm
      # -----------------------------------------
      - name: Login to GHCR for Helm
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io \
            --username ${{ github.actor }} \
            --password-stdin

      # -----------------------------------------
      # 11. Package and push Helm charts
      # -----------------------------------------
      - name: Package and push Helm charts
        run: |
          for DIR in charts/*/; do
            CHART_NAME=$(helm show chart "$DIR" | grep '^name:' | awk '{print $2}')
            CHART_VERSION=$(helm show chart "$DIR" | grep '^version:' | awk '{print $2}')

            echo "Packaging $CHART_NAME version $CHART_VERSION..."
            helm package "$DIR" --destination .

            echo "Pushing $CHART_NAME-$CHART_VERSION.tgz to GHCR..."
            helm push "$CHART_NAME-$CHART_VERSION.tgz" oci://ghcr.io/${{ github.repository }}/charts

            echo "✓ Published $CHART_NAME:$CHART_VERSION"
          done

      # -----------------------------------------
      # 12. Summary
      # -----------------------------------------
      - name: Release summary
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Release $TAG completed successfully!"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "Container Images:"
          echo "  • ghcr.io/${{ github.repository }}/dual-pods-controller:$TAG"
          echo "  • ghcr.io/${{ github.repository }}/launcher-populator:$TAG"
          echo "  • ghcr.io/${{ github.repository }}/launcher:$TAG"
          echo "  • ghcr.io/${{ github.repository }}/requester:$TAG"
          echo ""
          echo "Helm Charts (version $VERSION):"
          echo "  • oci://ghcr.io/${{ github.repository }}/charts/dual-pods-controller"
          echo "  • oci://ghcr.io/${{ github.repository }}/charts/launcher-populator"
          echo ""
          echo "Install with:"
          echo "  helm install dpctlr oci://ghcr.io/${{ github.repository }}/charts/dual-pods-controller --version $VERSION"
          echo "  helm install launcher-populator oci://ghcr.io/${{ github.repository }}/charts/launcher-populator --version $VERSION"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
